
/*
 * 
 * 
                 
                                              ``                                      
                                         +    @;                                      
                                         @#   @.                                      
                                         @@  @@                                       
                                        :#@ @+@                                       
                                        @+@@#+@                                       
                                       `@+@+++@@`                                     
                                       @++++++@@@@                                    
                                     #@+++++++++++##                                  
                             .@@@@@@@@+++++++++++++@@@@+                              
                           .@#+@@@@###++++++++++++#@@@@@@                             
                          #@++@@++++++++++++++++++++++@@@@                            
                         #@++@#+++++++++++++++++++++++++#@#                           
                        :@++#@++++++++''''''''''++++++++++@@                          
                        @+++@++++++++'''''''''''''+++++++++@#'                        
                       ##++++++++++''''''''''''''''+++++++++++@                       
                       @+++++++++@@@#+'''''''''''''+#+++++++++#@                      
                      :#+++++++@:,,,:@@@@#+'''+#@@':;@@#+++++++@                      
                      @++++++#@,,,,,,,,,,;'+++;,,,,,,,,@@++++++@@    +@@@@@@'         
        `@@@@@@@@,    @++++++@,,,,,,,,,,,,,,,,,,,,,,,,,,@@++++++@  @@++++++++@@       
       @@++++++++@@  ;++++++@,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@+++++@:@#+++++++++++@`     
     ,@++++++++++++@`@++++++#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@+++++@@++++++++++++++@`    
    :@++++++++++++++@@+++++@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@+++++@+++++++++++++++@    
   `@+++++++++++++++#@+++++@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:@+++++@+++@@@@@@@++++++@   
   @+++++#@@@@@@@+++##++++';,,,,,::::,,,,,,,,,,,,,::::,,,,,@+++++@##@@@@@@@@@@++++@:  
  '#++++@@@@@@@@@@##@+++++#,,,,,::::::,,,,,,,,,,,::::::,,,,@#++++@@@@@@;::::+@@++++@  
  @++++@@;:::::'@@@@@+++++@,,,,,::@#@':,,,,,,,,,:#:`+'::,,,#@++++@@@:,,,,:::::@@+++@` 
 ,@+++@@:::::,,,,,@@@+++++@,,,,::@````@,,,,,,,,:@````.;:,,,;@++++@#,,,,,,,,::::@++++@ 
 @+++#@::::,,,,,,,,'@+++++@,,,,:@``````;,,,,,,,;``````#:,,,:@++++#;,,,,,,,,,:::'@+++@ 
 @+++@;::,,,,,,,,,,,@+++++@,,,,::``````#,,,,,,,@```````',,,,@++++#,,,,,,,,,,,:::@+++@ 
 @+++@:::,,,,,,,,,,,@+++++#,,,:'````````:,,,,,:````,```@:,,:@++++@,,,,,,,,,,,,::@#++#.
,#++#@::,,,,,,,,,,,,@+++++#,,,:@``;##,``#,,,,,'``;###``#:,,:#++++@,,,,,,,,,,,,::+@+++'
'+++@+::,,,,,,,,,,,,@+++++@,,:#';;'';'.;@,,,,,#:.';'';;+#,,'+++++@,,,,,,,,,,,,::;@+++#
#+++@;::,,,,,,,,,,,,@+++++@,+,:'`:;;;;:.'+,,,''.,;;;;;`::;,@+++++@,,,,,,,,,,,,::;@+++@
@+++@;::,,,,,,,,,,,,@+++++@,',,'`;;;``;.';,,:,'`;.`;;;`;,,#@++++#+,,,,,,,,,,,,::'@+++@
#+++@'::,,,,,,,,,,,,@#++++@,;,,'`;;;``;`':++#,'`;:`;;;`',,#@++++@,,,,,,,,,,,,,::@#++++
++++#@::,,,,,,,,,,,,:@++++@,#,,;`:;:;;;`':#+#,;`:;;:;;`;,,'#++++@,,,,,,,,,,,,,::@+++#;
:#+++@::,,,,,,,,,,,,,@+++++'@,,,.`;;;;:.:',,,,,.`;;;;.`,,,@+++++@,,,,,,,,,,,,:::@+++@`
 @+++@;::,,,,,,,,,,,,@+++++@:,,,'`;;;;`,,;,,,+,'`;;;;`',,'@+++++@,,,,,,,,,,,:::@++++@ 
 @++++@:::,,,,,,,,,,,,@++++#,+,,,,`;;..'#,,,,,',.`,.`,,,,@@++++#',,,,,,,,,,:::'#++++@ 
 @#++++#:::,,,,,,,,,,:@+++++@,',,:....'+,,;';,,+;,..:,,,@@@++++@:,,,,,,,,,:::'@++++@` 
  @++++##::::,,,,,,,::'+++++#@,#'::'+#,'@@@#@@@;:#';:;#;#@+++++@:::,,,,:::::##++++#@  
  @@+++++@::::::,,::::@@++###@@,,,,,,,#@':,,@,;@,,,,,,,,@@##+++@+:::::::::;@++++++@   
   @#+++++@#:::::::::@#@######@,,,,,,,@:,@@,@',@,,,,,,,@@######@#@::::::+@#++++++@    
    @#++++++@@;::::'@##@####@@@,,,,,,,@@,#;,:,@@,,,,,,:@@######@###@@@@@#++++++#@     
     @@+++++++@@@@@###@@##@@@:,,,,,,,,,,,,,,,,,,,,,,,,,,,:#@@##@@@#+++++++++++@#      
      ,@+++++++++++#@@+@@@,,,,,,,,,,,,,,,,,+,,,,,,,,,,,,,,,,,;@@ +@@@#####@@@+        
        .@@@@@@@@@@@. ,@;,,,,,,,,,,,,,,,,,,',,,,,,,,,,,,,,,,,,,@`   `;#@#'.           
            `,:,`     @@,,,,,,,,,,,,,,,,,,,',,,,,,,,,,,,@@,,,,,,@                     
                     `@,,,,,,'@@;,,,,,,,,,,,,,,,,,,,,,#@@+,,,,,,@                     
                     '@,,,,,,@,@@@#,,,,,,,,,,,,,,,,,#@@@,,,,,,,,@;                    
                     ,@:,,,,,,,,'@;#@@#':,,,,,,;#@@@@@#,,,,,,,,:@                     
                      @@,,,,,,,,,:@,```';+@@@@#+:``:@;,,,,,,,,,@+                     
                       @@,,,,,,,,,,@```;   .  `````@,,,,,,,,,,@+                      
                        :@;,,,,,,,,,@+,.      ``:+@,,,,,,,,,@@`                       
                          '@',,,,,,,,@``.,:;;:.`.@,,,,,,,+@@`                         
                            :@@',,,,,,@'`    ``.@;,,,,#@@.                            
                               ;@@#,,,,@@:` `,@@+,,;@@`                               
                                  '@@@,,:@@@@@@;,,@@                                  
                                     @@@+,,:;,,,,@`                                   
                                       :@@+,,,,+@                                     
                                          ;@@@@                                                                    

 * 
 */

#include "Derivative.h" /* include peripheral declarations */
#include "arm_math.h"
#include "drivers/frdm-K20-def.h"
#include "drivers/mcg/mcg.h"
#include "drivers/sai/sai.h"
#include "cpu/arm_cm4.h"
#include "DSP/AudioIF.h"
#include "DSP/AudioProcess.h"
#include "drivers/adc16/adc16.h"
#include "drivers/io.h"
#include "DSP/IIR.h"


int main(void)
									{

    //Get up and running to 50MHz!
    pll_init(8000000, LOW_POWER, CRYSTAL, 4, 25, 1);
    InitIO();
    InitAudioProcess();
    EnableInterrupts;
    
    //Main Loop....  All audio processing goes on in the IRQ routine for the SAI!
    //The main loop will just read the pots and send updated coefficients to the processing IRQs
    //Note that computations in the foreground do not have to be very fast.  They will be using cycles not used by the
    //processing interrupt routines.  For now we will have no other IRQs to devote as much CPU time to the
    //audio processing
    
    //Switch into the desired Patch
   
   // ChangePatch(PATCH_PASS_THROUGH);
   //ChangePatch(PATCH_OVERDRIVE);
    //ChangePatch(PATCH_TUBEY_CLEAN);
    ChangePatch(PATCH_OD_DEMO_SINE_TEST);
    for(;;)
        {
            //In the main loop we will  read in the potentiometer values and update the processing routine
            switch(CurrentPatch)
                {
                    case PATCH_TUBEY_CLEAN:
                        //The Alpha Pot will be the gain/crunch value.  It will control a q_31t value from 0 to 1
                        //The use of the variable OD_Level is documented in the audio process routine.  We just need to generate it
                        //THis doesn't necessary need to be called every time through the loop but it won't Hurt anything.
                        SetPotLimits(POT_ALPHA,1000,4000);
                        //Since a Q31 is 31 bits of fraction and 1 bit of sign,  just
                        //multiply a binary value of 31 bits by the float and cast back to an integer
                        OD_Level = (q31_t)((float)0x7fffffff);
                        SetPotLimits(POT_BETA,0.001,1.5);
                        SetPotLimits(POT_GAMMA,-15,15.0 );
                       
                        DesignAudioBiquadIIR_q31_t(&MyIIR[0].Shadow_Coef,// Pointer to the IIR Structure
                        							BIQUAD_LOW_SHELF,
                                                   AudioSampleRate, //System Sample Rate
                                                   ReadPOT(POT_ALPHA), //f0 ("wherever it's happenin', man."  Center Frequency or
                                                   //Corner Frequency, or shelf midpoint frequency, depending
                                                   //on which filter type.  The "significant frequency".)*/
                                                   ReadPOT(POT_BETA),//(Q - the EE kind of definition, except for peakingEQ in which A*Q is
                                                   // the classic EE Q.  That adjustment in definition was made so that
                                                   // a boost of N dB followed by a cut of N dB for identical Q and
                                                   // f0/Fs results in a precisely flat unity gain filter or "wire".)*/
                                                   ReadPOT(POT_GAMMA)// dBgain (used only for peaking and shelving filters)
                                                  );
                      
                        DesignAudioBiquadIIR_q31_t(&MyIIR[1].Shadow_Coef,// Pointer to the IIR Structure
                                                                 BIQUAD_LOW_PASS_FILTER,
                                                                 AudioSampleRate, //System Sample Rate
                                                                 2500, //("wherever it's happenin', man."  Center Frequency or
                                                                 //Corner Frequency, or shelf midpoint frequency, depending
                                                                 //on which filter type.  The "significant frequency".)*/
                                                                 2.0,//(the EE kind of definition, except for peakingEQ in which A*Q is
                                                                 // the classic EE Q.  That adjustment in definition was made so that
                                                                 // a boost of N dB followed by a cut of N dB for identical Q and
                                                                 // f0/Fs results in a precisely flat unity gain filter or "wire".)*/
                                                                 0// (used only for peaking and shelving filters)
                                                                );
           
                        MyIIR[0].Update = 1;
                        MyIIR[1].Update = 1;
                        
                        //Flag the processing routine to copy the shadow coef. into the real ones.
                        break;

                    case PATCH_OVERDRIVE:
                        //The use of the variable OD_Level is documented in the audio process routine.  We just need to generate it
                        //THis doesn't necessary need to be called every time through the loop but it won't Hurt anything.
                        OD_Level =  (q31_t)0x7fffffff;
                        SetPotLimits(POT_BETA,0.01,.7);
                        SetPotLimits(POT_GAMMA,50,350);
                        SetPotLimits(POT_ALPHA,-40,40);
                        DesignAudioBiquadIIR_q31_t(&MyIIR[0].Shadow_Coef,// Pointer to the IIR Structure
                                                   BIQUAD_PEAKING_EQ,
                                                   AudioSampleRate, //System Sample Rate
                                                   ReadPOT(POT_GAMMA), //("wherever it's happenin', man."  Center Frequency or
                                                   //Corner Frequency, or shelf midpoint frequency, depending
                                                   //on which filter type.  The "significant frequency".)*/
                                                   ReadPOT(POT_BETA),//(the EE kind of definition, except for peakingEQ in which A*Q is
                                                   // the classic EE Q.  That adjustment in definition was made so that
                                                   // a boost of N dB followed by a cut of N dB for identical Q and
                                                   // f0/Fs results in a precisely flat unity gain filter or "wire".)*/
                                                   ReadPOT(POT_ALPHA)// (used only for peaking and shelving filters)
                                                  );
                        DesignAudioBiquadIIR_q31_t(&MyIIR[1].Shadow_Coef,// Pointer to the IIR Structure
                                                   BIQUAD_LOW_PASS_FILTER,
                                                   AudioSampleRate, //System Sample Rate
                                                   2000, //("wherever it's happenin', man."  Center Frequency or
                                                   //Corner Frequency, or shelf midpoint frequency, depending
                                                   //on which filter type.  The "significant frequency".)*/
                                                   2.0,//(the EE kind of definition, except for peakingEQ in which A*Q is
                                                   // the classic EE Q.  That adjustment in definition was made so that
                                                   // a boost of N dB followed by a cut of N dB for identical Q and
                                                   // f0/Fs results in a precisely flat unity gain filter or "wire".)*/
                                                   0// (used only for peaking and shelving filters)
                                                  );
                        //Copy in our value,   From there it will be used in the interrupt routine
                        MyIIR[0].Update = 1;
                        MyIIR[1].Update = 1;
                        break;
                        
                    case PATCH_OD_DEMO_SINE_TEST:     
                    	
                    	 SetPotLimits(POT_ALPHA,0,0x7fffffff);
                    	 OD_Level = ReadPOT(POT_ALPHA);
                    	 
                    	break;
                    	
                    	
                        
                    default:
                        break;
                }
        }

    return 0;
}
